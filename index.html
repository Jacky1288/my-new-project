<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X çƒ­é—¨èµ„è®¯ Â· ä¸­è‹±åŒè¯­</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2c;
      --text: #e6edf7;
      --sub: #9fb0cc;
      --accent: #50a2ff;
      --ok: #4ad295;
      --warn: #ffb74d;
      --line: #1f2b44;
      --tag-bg: #1a2c4a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #1d2b4a 0%, var(--bg) 60%);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
    }

    .muted {
      color: var(--sub);
      font-size: 14px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid var(--line);
      background: #14213a;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 14px;
      transition: border-color .2s;
    }

    button:hover { border-color: var(--accent); }
    button:disabled { opacity: .45; cursor: default; }

    select {
      border: 1px solid var(--line);
      background: #14213a;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
    }

    .status-bar {
      margin: 8px 0 14px;
      font-size: 14px;
      color: var(--sub);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--sub);
      flex-shrink: 0;
    }
    .dot.ok   { background: var(--ok);   box-shadow: 0 0 6px var(--ok); }
    .dot.warn { background: var(--warn); box-shadow: 0 0 6px var(--warn); }
    .dot.loading {
      background: var(--accent);
      animation: pulse 1.2s ease-in-out infinite;
    }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

    .news-list {
      display: grid;
      gap: 10px;
    }

    .news-item {
      background: linear-gradient(160deg, #131e34 0%, #0f1829 100%);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      transition: border-color .2s;
    }

    .news-item:hover { border-color: #2a4070; }

    /* ä¸­æ–‡æ ‡é¢˜ */
    .title-zh {
      margin: 0 0 6px;
      font-size: 17px;
      font-weight: 700;
      line-height: 1.55;
    }

    .title-zh a {
      color: var(--text);
      text-decoration: none;
    }

    .title-zh a:hover { color: var(--accent); text-decoration: underline; }

    /* è‹±æ–‡åŸæ–‡ */
    .title-en {
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--sub);
      line-height: 1.4;
    }

    .title-en a {
      color: var(--sub);
      text-decoration: none;
    }

    .title-en a:hover { color: var(--accent); }

    .meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
    }

    .tag {
      background: var(--tag-bg);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 2px 9px;
      color: var(--sub);
    }

    .skeleton {
      background: linear-gradient(90deg, var(--line) 25%, #1c2e4a 50%, var(--line) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 8px;
      height: 16px;
      margin-bottom: 8px;
    }

    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .skeleton-title { height: 20px; width: 90%; }
    .skeleton-sub   { height: 14px; width: 65%; }
    .skeleton-meta  { height: 14px; width: 40%; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <h1>ğ• çƒ­é—¨èµ„è®¯ Â· ä¸­è‹±åŒè¯­</h1>
        <div class="muted">èšåˆ X / Google çƒ­æœ / å…¨çƒæ–°é—»ï¼Œè‡ªåŠ¨ç¿»è¯‘ä¸ºä¸­æ–‡</div>
      </div>
      <div class="toolbar">
        <label class="muted" for="refresh-interval">è‡ªåŠ¨åˆ·æ–°</label>
        <select id="refresh-interval">
          <option value="30000" selected>30 ç§’</option>
          <option value="60000">1 åˆ†é’Ÿ</option>
          <option value="120000">2 åˆ†é’Ÿ</option>
          <option value="0">å…³é—­</option>
        </select>
        <button id="refresh-btn">âŸ³ ç«‹å³åˆ·æ–°</button>
      </div>
    </div>

    <div id="status-bar" class="status-bar">
      <span class="dot loading" id="status-dot"></span>
      <span id="status-text">æ­£åœ¨åŠ è½½æœ€æ–°èµ„è®¯...</span>
    </div>
    <div id="news-container" class="news-list"></div>
  </div>

  <script>
    const statusDot  = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const newsContainer = document.getElementById('news-container');
    const refreshBtn = document.getElementById('refresh-btn');
    const intervalSelect = document.getElementById('refresh-interval');

    let timer = null;
    let loading = false;

    function formatTime(iso) {
      if (!iso) return '';
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return '';
      return dt.toLocaleString('zh-CN', { hour12: false });
    }

    function setStatus(text, type = 'loading') {
      statusDot.className = `dot ${type}`;
      statusText.textContent = text;
    }

    function showSkeletons(n = 5) {
      newsContainer.innerHTML = Array.from({ length: n }).map(() => `
        <div class="news-item">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-sub"></div>
          <div class="skeleton skeleton-meta"></div>
        </div>
      `).join('');
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function renderNews(items) {
      if (!items || items.length === 0) {
        newsContainer.innerHTML = '<div class="news-item" style="color:var(--sub)">æš‚æ— å¯å±•ç¤ºçš„èµ„è®¯ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>';
        return;
      }

      newsContainer.innerHTML = items.map((item, i) => {
        const zhTitle   = escapeHtml(item.title_zh || item.title || 'ï¼ˆæ— æ ‡é¢˜ï¼‰');
        const enTitle   = escapeHtml(item.title || '');
        const url       = escapeHtml(item.url || '#');
        const source    = escapeHtml(item.icon ? `${item.icon} ${item.source}` : (item.source || 'æœªçŸ¥æ¥æº'));
        const timeStr   = formatTime(item.publishedAt);

        return `
          <article class="news-item">
            <p class="title-zh">
              <a href="${url}" target="_blank" rel="noopener noreferrer">${zhTitle}</a>
            </p>
            ${enTitle !== zhTitle ? `<p class="title-en"><a href="${url}" target="_blank" rel="noopener noreferrer">${enTitle}</a></p>` : ''}
            <div class="meta">
              <span class="tag">${source}</span>
              ${timeStr ? `<span class="muted">${timeStr}</span>` : ''}
            </div>
          </article>
        `;
      }).join('');
    }

    async function fetchNews() {
      if (loading) return;
      loading = true;
      refreshBtn.disabled = true;
      setStatus('æ­£åœ¨åŒæ­¥æœ€æ–°èµ„è®¯...', 'loading');
      showSkeletons();

      try {
        const res = await fetch('/api/x-trends', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderNews(data.items || []);

        const count = data.items?.length || 0;
        const updated = data.updatedAt ? formatTime(data.updatedAt) : '';
        setStatus(`å·²æ›´æ–°${updated ? 'ï¼ˆ' + updated + 'ï¼‰' : ''}ï¼Œå…± ${count} æ¡`, 'ok');
      } catch (err) {
        console.error('è·å–èµ„è®¯å¤±è´¥ï¼š', err);
        setStatus('åˆ·æ–°å¤±è´¥ï¼Œç¨åè‡ªåŠ¨é‡è¯•ã€‚', 'warn');
        newsContainer.innerHTML = '<div class="news-item" style="color:var(--warn)">âš ï¸ æš‚æ—¶æ— æ³•åŠ è½½èµ„è®¯ï¼Œè¯·ç¨åå†è¯•ã€‚</div>';
      } finally {
        loading = false;
        refreshBtn.disabled = false;
      }
    }

    function startAutoRefresh() {
      if (timer) clearInterval(timer);
      const ms = Number(intervalSelect.value);
      if (ms > 0) timer = setInterval(fetchNews, ms);
    }

    refreshBtn.addEventListener('click', fetchNews);
    intervalSelect.addEventListener('change', startAutoRefresh);

    fetchNews();
    startAutoRefresh();
  </script>
</body>
</html>